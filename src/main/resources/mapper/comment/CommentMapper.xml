<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.project.api.v1.comment.mapper.CommentMapper">

	<resultMap id="CommentDetailMap" type="com.ssafy.project.api.v1.comment.dto.CommentDetailResponse">
        <id property="commentId" column="comment_id" />
        <result property="postId" column="post_id" />
        <result property="content" column="content_md" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />

        <association property="author" javaType="com.ssafy.project.api.v1.comment.dto.CommentDetailResponse$AuthorInfo">
            <id property="userId" column="user_id"/>
            <result property="nickname" column="nickname"/>
        </association>
    </resultMap>
    
    <select id="getComment" resultMap="CommentDetailMap">
	    SELECT
	            c.comment_id,
	            c.post_id,
	            c.content_md,
	            c.created_at,
	            c.updated_at,
	            u.user_id,
	            u.nickname
	        FROM comments c
	        JOIN users u ON c.user_id = u.user_id
	        WHERE c.comment_id = #{commentId}
	          AND c.post_id = #{postId}
	          AND c.deleted_at IS NULL
    </select>
    
    <insert id="createComment" parameterType="com.ssafy.project.api.v1.comment.dto.CommentDto"
    		useGeneratedKeys="true" keyProperty="commentId">
    		INSERT INTO comments (post_id, user_id, content_md, created_at, updated_at)
    		VALUES (#{postId}, #{userId}, #{contentMd}, NOW(), NOW())
    </insert>
    
   <update id="updateComment">
   	UPDATE comments
   	SET
   		content_md = #{content},
   		updated_at = CURRENT_TIMESTAMP
   	WHERE comment_id = #{commentId} AND deleted_at IS NULL
   </update>
   
   <update id="deleteComment">
   UPDATE comments
   SET deleted_at = NOW()
   WHERE comment_id = #{commentId} AND deleted_at IS NULL
   </update>
   
   <!-- 게시글 삭제시 댓글도 함께 삭제 -->
   <update id="softDeleteByPostId">
	  UPDATE comments
	  SET deleted_at = NOW()
	  WHERE post_id = #{postId}
	    AND deleted_at IS NULL
	</update>
   
   
   <select id="countComments" resultType="int">
   	SELECT COUNT(*)
   	FROM comments
   	WHERE post_id=#{postId} AND deleted_at IS NULL
   </select>
   
   <select id="getCommentList" resultMap="CommentDetailMap">
   	SELECT
   		c.comment_id,
   		c.post_id,
   		c.content_md,
   		c.created_at,
   		c.updated_at,
   		u.user_id,
   		u.nickname
   	FROM comments c
   	JOIN users u On c.user_id = u.user_id
   	WHERE c.post_id = #{postId} AND c.deleted_at IS NULL
   	ORDER BY c.created_at ASC
   	LIMIT #{limit} OFFSET #{offset}
   </select>
    
	</mapper>
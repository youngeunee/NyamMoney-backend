<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.project.api.v1.post.mapper.PostMapper">	
	<resultMap id="PostMap" type="com.ssafy.project.api.v1.post.dto.PostDto">
	    <id property="postId" column="post_id"/>
	    <result property="boardId" column="board_id"/>
	    <result property="userId" column="user_id"/>
	    <result property="challengeId" column="challenge_id"/>
	    <result property="title" column="title"/>
	    <result property="contentMd" column="content_md"/>
	    <result property="likesCount" column="likes_count"/>
	    <result property="createdAt" column="created_at"/>
	    <result property="updatedAt" column="updated_at"/>
	    <result property="deletedAt" column="deleted_at"/>
	</resultMap>
	
	<resultMap id="PostDetailMap" type="com.ssafy.project.api.v1.post.dto.PostDetailResponse">
		<id property="postId" column="post_id"/>
		<result property="boardId" column="board_id"/>
		<result property="title" column="title" />
		<result property="content" column="content_md" />
		<result property="createdAt" column="created_at" />
		<result property="updatedAt" column="updated_at" />
		<result property="likeCount" column="likes_computed" />
		<result property="commentCount" column="comment_count" />
		
		<association property="author" javaType="com.ssafy.project.api.v1.post.dto.PostDetailResponse$AuthorInfo">
			<id property="userId" column="author_id" />
			<result property="nickname" column="author_nickname" />
		</association>
	</resultMap>
  
	<select id="getPostDetail" resultMap="PostDetailMap">
		SELECT 
            p.post_id, p.board_id, p.title, p.content_md,
            u.user_id AS author_id,
            u.nickname AS author_nickname,
            p.created_at, p.updated_at,
            (SELECT COUNT(*) FROM comments c WHERE c.post_id = p.post_id AND c.deleted_at IS NULL) AS comment_count,
            (SELECT COUNT(*) FROM post_likes pl WHERE pl.post_id = p.post_id) AS likes_computed
        FROM posts p
        JOIN users u ON p.user_id = u.user_id
        WHERE p.post_id = #{postId} AND p.deleted_at IS NULL
	</select>
	
	<insert id="createPost" parameterType="com.ssafy.project.api.v1.post.dto.PostDto"
            useGeneratedKeys="true" keyProperty="postId">
		INSERT INTO posts (board_id, user_id, challenge_id, title, content_md)
		VALUES ( #{boardId}, #{userId},
		<choose>
		    <when test="challengeId != null and challengeId != 0">
		        #{challengeId}
		    </when>
		    <otherwise>
		        NULL
		    </otherwise>
		</choose>,
		#{title}, #{contentMd})
	</insert>
	
	<update id="updatePost" parameterType="com.ssafy.project.api.v1.post.dto.PostDto">
		UPDATE posts
		SET
			title = #{title},
			content_md = #{contentMd},
			updated_at = CURRENT_TIMESTAMP
		WHERE post_id = #{postId} AND deleted_at IS NULL
	</update>
	
	<update id="deletePost">
		UPDATE posts
		SET deleted_at = CURRENT_TIMESTAMP
		WHERE post_id = #{postId}
	</update>
	
	
	<!-- 목록 조회 -->
    <select id="findPostList" resultMap="PostDetailMap">
        SELECT
            p.post_id,
            p.board_id,
            p.title,
            p.content_md,
            p.created_at,
            p.updated_at,
            (SELECT COUNT(*) FROM comments c WHERE c.post_id = p.post_id AND c.deleted_at IS NULL) AS comment_count,
            (SELECT COUNT(*) FROM post_likes pl WHERE pl.post_id = p.post_id) AS likes_computed,
            u.user_id AS author_id,
            u.nickname AS author_nickname
        FROM posts p
        JOIN users u ON p.user_id = u.user_id
        WHERE p.board_id = #{boardId}
          AND p.deleted_at IS NULL
        <if test="keyword != null">
            AND (p.title LIKE CONCAT('%', #{keyword}, '%')
                OR p.content_md LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY ${sort}
        LIMIT #{size} OFFSET #{offset}
    </select>
	
	<!-- 전체 개수 -->
    <select id="countPostList" resultType="long">
        SELECT COUNT(*)
        FROM posts p
        WHERE p.board_id = #{boardId}
          AND p.deleted_at IS NULL
        <if test="keyword != null">
            AND (p.title LIKE CONCAT('%', #{keyword}, '%')
                OR p.content_md LIKE CONCAT('%', #{keyword}, '%'))
        </if>
    </select>
    
    <select id="findById" parameterType="long" resultType="com.ssafy.project.api.v1.post.dto.Post">
	  SELECT
	    post_id     AS postId,
	    user_id     AS userId,
	    deleted_at  AS deletedAt
	  FROM posts
	  WHERE post_id = #{postId}
	</select>
    
    
    
	
	<!-- 좋아요 관련 -->
	<update id="increaseLike">
        UPDATE posts
        SET likes_count = likes_count + 1
        WHERE post_id = #{postId}
    </update>

    <update id="decreaseLike">
        UPDATE posts
        SET likes_count = likes_count - 1
        WHERE post_id = #{postId}
          AND likes_count > 0
    </update>

    <select id="getLikesCount" resultType="int">
        SELECT likes_count FROM posts WHERE post_id = #{postId}
    </select>
    
    <select id="existsPost" resultType="int">
	    SELECT COUNT(*)
	    FROM posts
	    WHERE board_id = #{boardId}
	      AND post_id = #{postId}
	      AND deleted_at IS NULL
	</select>
		
	
	</mapper>

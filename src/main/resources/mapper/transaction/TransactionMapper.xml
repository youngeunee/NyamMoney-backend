<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.project.api.v1.transaction.mapper.TransactionMapper">

  <!-- resultMap -->
  <resultMap id="TransactionCreateResponseMap"
             type="com.ssafy.project.api.v1.transaction.dto.TransactionCreateResponse">

    <id     property="transactionId" column="transaction_id"/>
    <result property="txType"         column="tx_type"/>
    <result property="amount"         column="amount"/>
    <result property="occurredAt"     column="occurred_at"/>

    <!-- SELECT에서 merchant_name_raw AS merchant_name 로 내려줌 -->
    <result property="merchantName"   column="merchant_name"/>

    <result property="memo"           column="memo"/>
    <result property="isRefund"       column="is_refund"/>
    <result property="impulseFlag"    column="impulse_flag"/>
    <result property="canceledAt"     column="canceled_at"/>
    <result property="createdAt"      column="created_at"/>

    <association property="category"
                 javaType="com.ssafy.project.api.v1.category.dto.CategoryItem"
                 columnPrefix="cat_">
      <id     property="categoryId" column="category_id"/>
      <result property="name"       column="name"/>
    </association>
  </resultMap>
	
	
<resultMap id="TransactionDetailResponseMap"
           type="com.ssafy.project.api.v1.transaction.dto.TransactionDetailResponse">

  <id     property="transactionId" column="transaction_id"/>
  <result property="txType"         column="tx_type"/>
  <result property="amount"         column="amount"/>
  <result property="occurredAt"     column="occurred_at"/>

  <result property="merchantName"   column="merchant_name"/>
  <result property="memo"           column="memo"/>
  <result property="tags"           column="tags"/>

  <result property="impulseFlag"    column="impulse_flag"/>
  <result property="isRefund"       column="is_refund"/>
  <result property="canceledAt"     column="canceled_at"/>

  <result property="createdAt"      column="created_at"/>
  <result property="updatedAt"      column="updated_at"/>

  <association property="category"
               javaType="com.ssafy.project.api.v1.category.dto.CategoryItem"
               columnPrefix="cat_">
    <id     property="categoryId" column="category_id"/>
    <result property="name"       column="name"/>
  </association>
</resultMap>	



  <insert id="insertTransaction"
          parameterType="com.ssafy.project.api.v1.transaction.dto.TransactionCreateParam"
          useGeneratedKeys="true"
          keyProperty="transactionId">

    INSERT INTO transactions (
      user_id,
      tx_type,
      amount,
      occurred_at,
      category_id,
      merchant_name_raw,
      memo,
      tags,
      is_refund,
      impulse_flag,
      canceled_at,
      source
    ) VALUES (
      #{userId},
      #{txType},
      #{amount},
      #{occurredAt},
      #{categoryId},
      #{merchantNameRaw},
      #{memo},
      #{tags},
      #{isRefund},
      #{impulseFlag},
      #{canceledAt},
      'manual'
    )
  </insert>

  <select id="selectCreateResponseById"
          resultMap="TransactionCreateResponseMap">

    SELECT
      t.transaction_id,
      t.tx_type,
      t.amount,
      t.occurred_at,
      t.merchant_name_raw AS merchant_name,
      t.memo,
      t.is_refund,
      t.impulse_flag,
      t.canceled_at,
      t.created_at,

      c.category_id AS cat_category_id,
      c.name        AS cat_name

    FROM transactions t
    LEFT JOIN categories c
      ON c.category_id = t.category_id
    WHERE t.user_id = #{userId}
      AND t.transaction_id = #{transactionId}
  </select>
	
	
	<update id="updateTransaction"
          parameterType="com.ssafy.project.api.v1.transaction.dto.TransactionUpdateParam">
          UPDATE transactions
          <set>
          	<if test="txType != null">tx_type = #{txType},</if>
	      	<if test="amount != null">amount = #{amount},</if>
	      	<if test="occurredAt != null">occurred_at = #{occurredAt},</if>
	      	<if test="categoryId != null">category_id = #{categoryId},</if>
		    <if test="merchantNameRaw != null">merchant_name_raw = #{merchantNameRaw},</if>
		    <if test="memo != null">memo = #{memo},</if>
	      	<if test="tags != null">tags = #{tags},</if>
	      	<if test="impulseFlag != null">impulse_flag = #{impulseFlag},</if>
	      	<if test="isRefund != null">is_refund = #{isRefund},</if>
	      	<if test="canceledAt != null">canceled_at = #{canceledAt},</if>
	      	<if test="isRefund != null and isRefund == false">canceled_at = NULL,</if>
	
	      	updated_at = CURRENT_TIMESTAMP
	      </set>
	      WHERE transaction_id = #{transactionId}
	      AND user_id = #{userId}
	      AND deleted_at IS NULL
    </update>
    <select id="selectDetailById"
          resultMap="TransactionDetailResponseMap">
    SELECT
      t.transaction_id,
      t.tx_type,
      t.amount,
      t.occurred_at,
      t.merchant_name_raw AS merchant_name,
      t.memo,
      t.tags,
      t.impulse_flag,
      t.is_refund,
      t.canceled_at,
      t.created_at,
      t.updated_at,

      c.category_id AS cat_category_id,
      c.name        AS cat_name

    FROM transactions t
    LEFT JOIN categories c
      ON c.category_id = t.category_id
    WHERE t.user_id = #{userId}
      AND t.transaction_id = #{transactionId}
      AND t.deleted_at IS NULL
  </select>


	<update id="deleteTransaction">
	  UPDATE transactions
	  SET deleted_at = CURRENT_TIMESTAMP
	  WHERE transaction_id = #{transactionId}
	    AND user_id = #{userId}
	    AND deleted_at IS NULL
	</update>
	
	<select id="selectSummary"
        parameterType="com.ssafy.project.api.v1.transaction.dto.TransactionSummaryQuery"
        resultType="com.ssafy.project.api.v1.transaction.dto.TransactionSummaryResponse">

	  <![CDATA[
	  SELECT
	    COALESCE(SUM(
	      CASE
	        WHEN tx_type = 'EXPENSE'
	             AND is_refund = 0
	             AND canceled_at IS NULL
	        THEN amount
	        ELSE 0
	      END
	    ), 0) AS totalExpense,
	
	    COALESCE(SUM(
	      CASE
	        WHEN tx_type = 'EXPENSE'
	             AND impulse_flag = 1
	             AND is_refund = 0
	             AND canceled_at IS NULL
	        THEN amount
	        ELSE 0
	      END
	    ), 0) AS totalImpulseExpense
	
	  FROM transactions
	  WHERE user_id = #{userId}
	    AND occurred_at >= #{from}
	    AND occurred_at <= #{to}
	    AND deleted_at IS NULL
	  ]]>
	</select>
</mapper>

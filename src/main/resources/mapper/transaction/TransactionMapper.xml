<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.project.api.v1.transaction.mapper.TransactionMapper">

  <!-- resultMap -->
  <resultMap id="TransactionCreateResponseMap"
             type="com.ssafy.project.api.v1.transaction.dto.TransactionCreateResponse">

    <id     property="transactionId" column="transaction_id"/>
    <result property="txType"         column="tx_type"/>
    <result property="amount"         column="amount"/>
    <result property="occurredAt"     column="occurred_at"/>

    <!-- SELECT에서 merchant_name_raw AS merchant_name 로 내려줌 -->
    <result property="merchantName"   column="merchant_name"/>

    <result property="memo"           column="memo"/>
    <result property="isRefund"       column="is_refund"/>
    <result property="impulseFlag"    column="impulse_flag"/>
    <result property="canceledAt"     column="canceled_at"/>
    <result property="createdAt"      column="created_at"/>

    <association property="category"
                 javaType="com.ssafy.project.api.v1.category.dto.CategoryItem"
                 columnPrefix="cat_">
      <id     property="categoryId" column="category_id"/>
      <result property="name"       column="name"/>
    </association>
  </resultMap>
	
	
	<resultMap id="TransactionDetailResponseMap"
	           type="com.ssafy.project.api.v1.transaction.dto.TransactionDetailResponse">
	
	  <id     property="transactionId" column="transaction_id"/>
	  <result property="txType"         column="tx_type"/>
	  <result property="amount"         column="amount"/>
	  <result property="occurredAt"     column="occurred_at"/>
	
	  <result property="merchantName"   column="merchant_name"/>
	  <result property="memo"           column="memo"/>
	  <result property="tags"           column="tags"/>
	
	  <result property="impulseFlag"    column="impulse_flag"/>
	  <result property="isRefund"       column="is_refund"/>
	  <result property="canceledAt"     column="canceled_at"/>
	
	  <result property="createdAt"      column="created_at"/>
	  <result property="updatedAt"      column="updated_at"/>
	
	  <association property="category"
	               javaType="com.ssafy.project.api.v1.category.dto.CategoryItem"
	               columnPrefix="cat_">
	    <id     property="categoryId" column="category_id"/>
	    <result property="name"       column="name"/>
	  </association>
	</resultMap>	

	<resultMap id="TransactionItemMap"
	           type="com.ssafy.project.api.v1.transaction.dto.TransactionItem">
	  <id     property="transactionId"   column="transaction_id"/>
	  <result property="occurredAt"      column="occurred_at"/>
	  <result property="amount"          column="amount"/>
	  <result property="paymentMethod"   column="payment_method"/>
	  <result property="merchantNameRaw" column="merchant_name_raw"/>
	  <result property="impulseFlag"     column="impulse_flag"/>
	  <result property="isRefund"        column="is_refund"/>
	</resultMap>	
	
	<resultMap id="TransactionSummaryResponseMap"
	           type="com.ssafy.project.api.v1.transaction.dto.TransactionSummaryResponse">
	  <result property="from" column="from_at"/>
	  <result property="to" column="to_at"/>
	  <result property="totalExpense" column="total_expense"/>
	  <result property="totalImpulseExpense" column="total_impulse_expense"/>
	</resultMap>
	
	<resultMap id="TransactionDailySummaryItemMap"
	           type="com.ssafy.project.api.v1.transaction.dto.TransactionDailySummaryItem">
	  <result property="date" column="date"/>
	  <result property="totalExpense" column="total_expense"/>
	  <result property="totalImpulseExpense" column="total_impulse_expense"/>
	</resultMap>




  <insert id="insertTransaction"
          parameterType="com.ssafy.project.api.v1.transaction.dto.TransactionCreateParam"
          useGeneratedKeys="true"
          keyProperty="transactionId">

    INSERT INTO transactions (
      user_id,
      tx_type,
      amount,
      occurred_at,
      category_id,
      merchant_name_raw,
      memo,
      tags,
      is_refund,
      impulse_flag,
      canceled_at,
      source
    ) VALUES (
      #{userId},
      #{txType},
      #{amount},
      #{occurredAt},
      #{categoryId},
      #{merchantNameRaw},
      #{memo},
      #{tags},
      #{isRefund},
      #{impulseFlag},
      #{canceledAt},
      'manual'
    )
  </insert>

  <select id="selectCreateResponseById"
          resultMap="TransactionCreateResponseMap">

    SELECT
      t.transaction_id,
      t.tx_type,
      t.amount,
      t.occurred_at,
      t.merchant_name_raw AS merchant_name,
      t.memo,
      t.is_refund,
      t.impulse_flag,
      t.canceled_at,
      t.created_at,

      c.category_id AS cat_category_id,
      c.name        AS cat_name

    FROM transactions t
    LEFT JOIN categories c
      ON c.category_id = t.category_id
    WHERE t.user_id = #{userId}
      AND t.transaction_id = #{transactionId}
  </select>
	
	
	<update id="updateTransaction"
          parameterType="com.ssafy.project.api.v1.transaction.dto.TransactionUpdateParam">
          UPDATE transactions
          <set>
          	<if test="txType != null">tx_type = #{txType},</if>
	      	<if test="amount != null">amount = #{amount},</if>
	      	<if test="occurredAt != null">occurred_at = #{occurredAt},</if>
	      	<if test="categoryId != null">category_id = #{categoryId},</if>
		    <if test="merchantNameRaw != null">merchant_name_raw = #{merchantNameRaw},</if>
		    <if test="memo != null">memo = #{memo},</if>
	      	<if test="tags != null">tags = #{tags},</if>
	      	<if test="impulseFlag != null">impulse_flag = #{impulseFlag},</if>
	      	<if test="isRefund != null">is_refund = #{isRefund},</if>
	      	<if test="canceledAt != null">canceled_at = #{canceledAt},</if>
	      	<if test="isRefund != null and isRefund == false">canceled_at = NULL,</if>
	
	      	updated_at = CURRENT_TIMESTAMP
	      </set>
	      WHERE transaction_id = #{transactionId}
	      AND user_id = #{userId}
	      AND deleted_at IS NULL
    </update>
    <select id="selectDetailById"
          resultMap="TransactionDetailResponseMap">
    SELECT
      t.transaction_id,
      t.tx_type,
      t.amount,
      t.occurred_at,
      t.merchant_name_raw AS merchant_name,
      t.memo,
      t.tags,
      t.impulse_flag,
      t.is_refund,
      t.canceled_at,
      t.created_at,
      t.updated_at,

      c.category_id AS cat_category_id,
      c.name        AS cat_name

    FROM transactions t
    LEFT JOIN categories c
      ON c.category_id = t.category_id
    WHERE t.user_id = #{userId}
      AND t.transaction_id = #{transactionId}
      AND t.deleted_at IS NULL
  </select>


	<update id="deleteTransaction">
	  UPDATE transactions
	  SET deleted_at = CURRENT_TIMESTAMP
	  WHERE transaction_id = #{transactionId}
	    AND user_id = #{userId}
	    AND deleted_at IS NULL
	</update>
	
	<select id="selectSummary"
	        parameterType="com.ssafy.project.api.v1.transaction.dto.TransactionSummaryQuery"
	        resultMap="TransactionSummaryResponseMap">
	
	  SELECT
	    #{from} AS from_at,
	    #{to}   AS to_at,
	
	    COALESCE(SUM(
	      CASE
	        WHEN tx_type = 'EXPENSE'
	             AND is_refund = 0
	             AND canceled_at IS NULL
	        THEN amount
	        ELSE 0
	      END
	    ), 0) AS total_expense,
	
	    COALESCE(SUM(
	      CASE
	        WHEN tx_type = 'EXPENSE'
	             AND impulse_flag = 1
	             AND is_refund = 0
	             AND canceled_at IS NULL
	        THEN amount
	        ELSE 0
	      END
	    ), 0) AS total_impulse_expense
	
	  FROM transactions
	  WHERE user_id = #{userId}
	    AND occurred_at <![CDATA[>=]]> #{from}
	    AND occurred_at <![CDATA[<=]]> #{to}
	    AND deleted_at IS NULL
	</select>
	
	
	
	<select id="selectTransactionsCursor" resultMap="TransactionItemMap">
	  SELECT
	    t.transaction_id,
	    t.occurred_at,
	    t.amount,
	    t.payment_method,
	    t.merchant_name_raw,
	    t.impulse_flag,
	    t.is_refund
	  FROM transactions t
	  WHERE t.deleted_at IS NULL
	    AND t.user_id = #{userId}
	    AND t.occurred_at &gt;= #{from}
	    AND t.occurred_at &lt;= #{to}
	
	    <!-- cursor가 있을 때만 적용 -->
	    <if test="cursorOccurredAt != null and cursorTransactionId != null">
	      AND (
	        t.occurred_at &lt; #{cursorOccurredAt}
	        OR (t.occurred_at = #{cursorOccurredAt} AND t.transaction_id &lt; #{cursorTransactionId})
	      )
	    </if>
	
	  ORDER BY t.occurred_at DESC, t.transaction_id DESC
	  LIMIT #{limit}
	</select>
	
	<select id="countTransactionsByPeriod" resultType="long">
	  SELECT COUNT(*)
	  FROM transactions t
	  WHERE t.deleted_at IS NULL
	    AND t.user_id = #{userId}
	    AND t.occurred_at &gt;= #{from}
	    AND t.occurred_at &lt;= #{to}
	</select>
	
	<select id="selectDailySummary"
	        parameterType="com.ssafy.project.api.v1.transaction.dto.TransactionSummaryQuery"
	        resultMap="TransactionDailySummaryItemMap">
	
	  SELECT
	    DATE(t.occurred_at) AS date,
	
	    COALESCE(SUM(
	      CASE
	        WHEN t.tx_type = 'EXPENSE'
	             AND t.is_refund = 0
	             AND t.canceled_at IS NULL
	        THEN t.amount
	        ELSE 0
	      END
	    ), 0) AS total_expense,
	
	    COALESCE(SUM(
	      CASE
	        WHEN t.tx_type = 'EXPENSE'
	             AND t.impulse_flag = 1
	             AND t.is_refund = 0
	             AND t.canceled_at IS NULL
	        THEN t.amount
	        ELSE 0
	      END
	    ), 0) AS total_impulse_expense
	
	  FROM transactions t
	  WHERE t.user_id = #{userId}
	    AND t.occurred_at <![CDATA[>=]]> #{from}
	    AND t.occurred_at <![CDATA[<=]]> #{to}
	    AND t.deleted_at IS NULL
	
	  GROUP BY DATE(t.occurred_at)
	  ORDER BY DATE(t.occurred_at) ASC
	</select>	
	
	<insert id="upsertNhCardTransaction"
            parameterType="com.ssafy.project.api.v1.integration.nhcard.dto.TransactionUpsertParam">

        INSERT INTO transactions (
            user_id,
            occurred_at,
            amount,
            tx_type,

            category_id,
            merchant_name_raw,
            payment_method,
            memo,
            tags,

            source,
            card_auth_no,
            sales_type,
            installment_months,
            currency_code,

            impulse_flag,
            is_refund,
            canceled_at
        )
        VALUES (
            #{userId},
            #{occurredAt},
            #{amount},
            #{txType},

            #{categoryId},
            #{merchantNameRaw},
            #{paymentMethod},
            #{memo},
            #{tags},

            #{source},
            #{cardAuthNo},
            #{salesType},
            #{installmentMonths},
            #{currencyCode},

            #{impulseFlag},
            #{isRefund},
            #{canceledAt}
        )
        ON DUPLICATE KEY UPDATE
            amount              = VALUES(amount),
            category_id         = VALUES(category_id),
            payment_method      = VALUES(payment_method),
            sales_type          = VALUES(sales_type),
            installment_months  = VALUES(installment_months),
            currency_code       = VALUES(currency_code),
            is_refund           = VALUES(is_refund),
            canceled_at         = VALUES(canceled_at),
            updated_at          = CURRENT_TIMESTAMP
    </insert>
<select id="findExistingNhAuthNos" resultType="string">
  SELECT card_auth_no
  FROM transactions
  WHERE user_id = #{userId}
    AND source = #{source}
    AND card_auth_no IN
    <foreach collection="authNos" item="no" open="(" separator="," close=")">
      #{no}
    </foreach>
</select>

	<insert id="insertNhCardTransaction" parameterType="com.ssafy.project.api.v1.integration.nhcard.dto.TransactionUpsertParam">
	  INSERT INTO transactions (
	    user_id, occurred_at, amount, tx_type,
	    category_id, category_method,
	    merchant_name_raw, payment_method, memo, tags,
	    source, card_auth_no, sales_type, installment_months, currency_code,
	    impulse_flag, is_refund, canceled_at
	  ) VALUES (
	    #{userId}, #{occurredAt}, #{amount}, #{txType},
	    #{categoryId}, #{categoryMethod},
	    #{merchantNameRaw}, #{paymentMethod}, #{memo}, #{tags},
	    #{source}, #{cardAuthNo}, #{salesType}, #{installmentMonths}, #{currencyCode},
	    #{impulseFlag}, #{isRefund}, #{canceledAt}
	  )
	</insert>


</mapper>
